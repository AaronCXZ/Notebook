Kubernetes中对任何二昂利实现都规定了以下的以下要求：

- 所有的Pod都可以在不使用NAT的情况下与所有其他Pod进行通信
- 所有节点都可以在没有NAT的情况下与所有Pod进行通信
- Pod自己的IP与其他Pod看到的IP是相同的

基于这些限制，需要解决几个不同的网络问题：

1. 容器到容器的网络
2. Pod到Pod的网络
3. Pod到Service的网络
4. 互联网到Service的网络

#### 容器到容器的网络

​		一个Pod会被构建成一组共享网络命名空间的Docker容器，Pod中的容器都有相同的IP地址和端口空间，它们都是通过分配给Pod的网络命名空间来分配的，并且可以通过localhost访问彼此，因为它们位于同一个命名空间中。这是使用Docker作为Pod容器实现的，它持有网络命名空间，二应用容器则通过Docker的```-net=contaner:sandbox-container```功能加入到该命名空间中。

#### Pod到Pod的网络

​		每个Pod都有一个真是的IP地址，每个Pod都使用该IP地址与其他Pod进行通信。

​		命名空间可以使用Linux虚拟以太网设备或由两个虚拟接口组成```veth```对进行对接，这些虚拟接口可以分布在多个命名空间上。将```veth```的一侧分配给root network namespace，将另一侧分配给Pod的网络命名空间，就实现了Pod命名空间与相同root network namespace的连接。

​		现在需要Pod能通过root命名空间进行通信，可以使用一个网络bridge（网桥）来实现。Linux bridge是用纯软件实现的虚拟交换机，有着和网络交换机相同的功能。因此我们可以把```veth pair```等设备绑定到网桥上，就像把物理设备连接到物理交换机上一样。

​		Bridge的工作方式是通过检查通过它的数据包目的地，并决定是否将数据包传递给连接到网桥的其他网段，从而在源和目的地之间维护一个转发表。bridge通过查看网络中每个以太网设备的唯一MAC地址来决定是桥接数据还是丢弃数据。Bridge实现了ARP协议来发现与指定IP地址关联的链路层MAC地址。

#### 同节点Pod通信

​		网络命名空间将每个Pod隔离到自己的网络堆栈中，虚拟以太网设备将每个命名空间连接到根命名空间，以及一个将命名空间连接在一起的网桥，这样就可以实现同节点Pod之间互相通信了。

#### 跨节点Pod通信

​		通常集群中的每个节点都分配有一个```CIDR```，用来指定该节点上运行Pod可用的IP地址，一旦以```CIDR```为目的地的流量到达节点，节点就会将流量绽放到正确的Pod。

​		源地址Pod1的数据包通过自己的eth0发送到根命名空间，最终到达对应的网桥上，这时网桥上的ARP会失败，因为与网桥相连的没有正确的数据包MAC地址。一旦失败网桥会将数据包发送到默认路由上，根网络命名空间的eth0设备，此时就会路由离开节点进入网络。网络可以根据分配给节点的```CIDR```将数据包路由到正确的节点。数据包进入目标节点的根网络命名空间的eth0，这里可以通过网桥路由到省却的虚拟设备```veth```上，最后到达目标Pod的eth0。

#### Pod到Service

​		Service作为对Pod的抽象，为一组Pod分配一个虚拟的VIP（也称为clusterIP）地址，任何发往Service VIP的流量都会被路由到与其关联的一组Pod。

#### netfilter与iptables

​		Netfilter是Linux提供的一个框架，它允许以自定义处理程序的形式实现各种与网络相关的操作，Netfilter为数据包过滤、网络地址转换和端口转换提供了各种功能和操作，它们提供了引导数据包提供网桥所需的功能，以及提供禁止数据包到达计算机网络中敏感位置的能力。

​		iptables是一个用户空间程序，它提供了一个基于table的相同，用于定义使用netfilter框架操作和转换数据包的规则。在kubernetes中iptables规则由kube-proxy控制器配置。

#### IPVS

​		IPVS也是构建在netfilter之上的，并作为Linux内核的一部分实现了传输层的负载均衡。IPVS被合并到了LVS中，它在主机上运行并充当真实服务器集群前面的负载均衡器，IPVS科技将基于TCP和UDP的服务请求定向到真实服务器，并使真实服务器的服务作为虚拟服务出现在一个IP地址上，这使得IPVS非常适合Kubernetes服务。IPVS专为负载均衡而设计，并使用更高效的数据结构，与iptables相比允许更大的规模。

使用IPVS模式的Service时会发生三件事：

1. 在Node节点上创建 一个虚拟IPVS接口
2. 将Service的VIP地址绑定到虚拟IPVS接口
3. 为每个Service VIP地址创建IPVS服务器

###### 

