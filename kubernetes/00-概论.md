### 通过一个Deployment来启动一个Pod来说明一系列控制器和控制平面中组件的协同工作

1. Deployment 的控制器（在 kube-controller-manager 中）会发现（通过Deployment Informer）用户创建了一个 Deployment，并执行相关的业务逻辑：创建一个 ReplicaSet 对象。
2. ReplicaSet 的控制器（同样在 kube-controller-manager 中）会发现（通过ReolicaSet Informer）这个新创建的ReplicaSet，并执行其相关的业务逻辑：创建一个Pod对象。
3. 调度器（在kube-scheduler中）本身是一个控制器，它发现了新创建的Pod（通过Pod Informer），并且这个Pod的spec,nodeName字段是空值。调度器执行的业务逻辑就是把这个Pod放入到它的调度队列。
4. 与此同时。kubelet（它是一个控制器）发现了这个新创建Pod（通过它的Pod Informer）。
5. 由于这个新Pod的pec,nodeName字段是空值，与本kubelet所在节点的名字不同，所以忽略了这个Pod，并继续等待下一个事件到来。
6. 调度器把Pod从工作队列中取出来，把它调度到一个具备足够资源的节点上，并把节点的名字更新到Pod的pec,nodeName字段中，然后把它写入到API服务器中。
7. 由于上一步操作产生了新的Pod更新事件，kubelet再次被唤醒。它再次比较Pod的pec,nodeName字段值与自身所在的节点名字，如果两个名字一致，这个kubelet就会启动Pod所需要的容器，并把容器启动成功的信息写入Pod的Status中，回报到API服务器上。
8. ReplicaSet控制器收到Pod状态变化的事件，不过它没有什么工作要做。
9. 最终，Pod运行结束。kubelet发现了这个事件，从API服务器获取Pod的对象，并把Pod的状态设置为“已禁止”，写回服务器。
10. ReplicaSet控制器发现POd运行结束了，它认为这个Pod需要被替换掉，它把已终止的Pod在API服务器上删除，然后重新创建一个新的Pod。
11. 重复上面的处理过程。

- Watch事件：在API服务器与控制器之间通过HTTP流的方式发送，用于驱动Informer。
- 顶层Event对象：是Pod，Deployment或Service等相似的资源，它具有一个特殊的属性，即长度为一小时的生命周期。如果这个对象的存在时间超出了这个阈值，就会从etcd中自动删除。是一种用户可见的日志机制，很多控制器都会创建这样的Event对象用于对用户展示其业务逻辑。

### 边沿触发与水平触发

- 边沿触发：当状态变化发生时，触发一个处理动作。
- 水平触发：定期检查状态，如果某种特定的条件满足，就触发一个处理动作。

水平触发是轮询的一种，当对象数量变多时，它很难扩展，并且控制器发现状态变化的延迟取决于轮询的频率以及API服务器的服务能力。当有很多异步控制器存在时，结果就是整个系统需要花费很长的时间才能完成到达目标状态的转换。

边沿触发的方式在对象数量较多时更高效，处理延迟主要取决于控制器中处理事件的工作线程数。

kubernetes的实现都是基于边沿触发这种事件模式。

在kubernetes的控制平面中，很多组件会去修改API服务器中的对象，每次变动都会产生一个新的事件，即一个边沿。

### 处理出错情况的方案

- 在仅仅依赖边沿驱动的场景中，有可能会丢失一个后续的事件
- 在边沿触发的场景下，处理事件时总是去重新获取最新的状态，即水平。也就是说业务逻辑是边沿触发，水平驱动
- 边沿触发加上水平驱动的逻辑，同时辅以额外的重新同步逻辑

第一种策略无法正确处理丢失的事件

第二种策略能从上述的问题中恢复

第三种策略额外添加了持续的重新同步

kubernetes的控制器选择了第三种策略来实现。

### 乐观锁

每个资源都有一个对应的etcd的键值对版本每一个整型数字的字符串。

当更新资源状态时，获取资源当前的状态，对应一个版本号，完成一系列动作之后，尝试去更新资源的状态，这时发现版本号有更新，而控制器发出的请求中还是写着旧的版本号，这个更新请求就会失败。这是就需要重试机制再次尝试更新资源。

### Openator需要满足的三个条件

- 包含一些领域相关的运维知识，用于通过程序来实现自动化运行
- 这些运维知识已经被总结为一些最佳实践，并可以显示描述出来。
- 作为Operator的发布品应包括：
  - 一组自定义资源定义CRD，用于定义领域相关的Schema。与之对应的自定义资源，用于描述实例级别的领域相关信息
  - 一个自定义的控制器，用来管理自定义资源，同时也会涉及其他一些核心资源。比如某个自定义的控制器可能会拉起一个Pod
